---
title: Геолокация в подробностях
date: 2023-08-26
layout: post
---

## Ссылки и соединение

> Cсылки приведены для информации, а не для экспериментирования. Если вы хотите что-то узнать, то пожалуйста, спрашивайте в чате. Это рабочий сервис, здесь никто не рад тренировкам в сезон.
{: .block-warning }

### Адрес служебной страницы
Служебная страница: [https://gps.extremum.org/m](https://gps.extremum.org/m)

> Если вы часто пользуетесь служебной страницей, то пожалуйста добавьте её в закладки, не ищите её в адресной строке браузера или в поисковой системе. Потому что и те, и другие будут заглядывать на сервис без необходимости, создавая ненужные заходы и определения координат.
{: .block-warning }

## Использование

**Пользователь открывает ссылку на страницу определения координат**

Ссылка открывается в браузере на мобильном устройстве пользователя. Из-за требований браузеров после 2017 года определение координат требует безопасного соединения, такая ссылка начинается с HTTP**S**.

<div class="table-wrapper" markdown="block">

**Ссылка для определения координат**
```markdown
https://gps.extremum.org
```
Ссылка определения координат для очень старых устройств, если последнее обновление системы точно до 2017 года
```markdown
http://gps.extremum.org
```

Ссылки лучше всего отправлять с помощью SMS. Доставка SMS надёжна, а расход заряда на их получение в десятки тысяч раз меньше, чем получение сообщения через какой-нибудь мессенджер, которому обязательно надо будет проверить и скачать все новые аватарки контактов и чатов, узнать, что у кого нового, нет ли обновлений, и интенсивно пообщаться со своими серверами. Расход заряда на это неуместен при проведении поисково-спасательных работ. Заходы из мессенджеров и социальных сетей или из поисковых систем могут быть отсечены, это отсекает любопытствующих и праздношатающихся. Ещё раз — отправляйте ссылку через СМС.

Если отправить вторую ссылку новому устройству, то произойдёт много ненужной суеты. Устройство в процессе подключения к серверу выяснит, что существует первая ссылка, и переподключится туда, совершая лишний расход времени и трафика с соответствующими рисками. Отправляйте второй вариант, если вы заранее знаете, что устройство очень старое, или первая ссылка не открывается с ошибкой о небезопасности.

> Чтобы установить безопасное соединение, устройство должно доверять центру сертификации, который подтверждает подлинность сайта определения координат. Устройства, которые были последний раз обновлены до 2015 года могут не доверять новым центрам сертификации и показывать ошибку. Но, так как до 2017 года для определения координат браузерам не требовалось безопасное соедениение, то будет нормально отправить ссылку без http, кроме того, само соединение будет установлено быстрее.
>
> Соединение устанавливается по одной из версий протокола HTTP 1.1, 2 или 3. В процессе соединения сервер сообщает о своих возможностях клиентскому устройству, и оно будет использовать самый современный из известных ему вариантов. Более поздние протоколы имеют огромное преимущество в нестабильных сетях, особенно хорошо работает HTTP3 для которого переподключение мобильного устройства пользователя к разным базовым станциям сотовой связи не означает гарантированный обрыв соединения, как это происходит со старыми сервисами. Если вы видели когда-нибудь сообщение вида ERR_NETWORK_CHANGED в браузере, то такое происходит только на старых версиях протоколов, если устройство переподключается к разным сетям в процессе работы. У нас переподключение сколько-нибудь современных устройств происходит без подобных ошибок.
>
> Устройство в процессе соединения всегда сообщает серверу свои возможности по приёму сжатого трафика. Сервер выбирает лучший поддерживаемый алгоритм сжатия, использует его и упаковывает свои ответы с максимальными настройками. Кроме того, страницы отправляемые клиенту, упрощаются до предела: из них удаляетется всё, что не критически необходимо для работы, поэтому ответ сервера в десятки тысяч раз компактнее, чем скачивание приложения, и как минимум в десятки раз меньше, чем страницы без подобных ухищрений. Сжатые данные скачиваются намного быстрее, а это сокращает расход заряда устройства. Распаковка данных на порядки менее энергоёмкая операция, чем подключения к медленным нестабильным сетям.

## Заход устройства и подготовка к работе  

<div class="table-wrapper" markdown="block">

|Сообщение|Смысл|
|-|:-|
|Заход|Устройство обратилось к странице и загрузило её содержимое. Значит, что связь есть, устройство может запрашивать и отправлять данные.|
||Первый заход|
||Не первый заход. Означает, что устройство уже заходило, получило и хранит свой идентификатор. Если такое происходит внутри одного сеанса, то это нормально, просто второй раз нажали на ссылку. Если сеанс начинается именно с этого, возможно, что потерявшийся — «рецидивист». А может быть это пользователь ГИС для ПСО, который никак не может запомнить, на какую страницу нужно заходить. Не будьте такими пользователями.|
|Ответ|Когда устройство открывает страницу, оно отчитывается сервису о том, что страница полностью загрузилась, и готова к использованию. Это важнейший диагностический критерий. Только в этот момент на gis.extremum.org при включённом слое геолокации приходит уведомление «новый заход».|
|Компас|Появляется, когда сервер отмечает загрузку страницы компаса. Показывает запрошенный азимут.|
|Дозагрузка|Страница подготавливает запчасти для последующей работы без сети. Происходит с задержкой десять секунд после начала работы и позволяет не мешать передаче остальных данных. Это значит, что в следующий раз та же самая страница на устройстве может открыться уже без Захода, а сразу на стадии Ответ. Просто потому, что заход будет не на сервер, а в специальное хранилище, куда только что и были загружены «запчасти». Радикально повышает надёжность и экономит время при повторных открытиях страницы в условиях нестабильной сети.|
||Оффлайн недоступен. Это сообщение появляется вместо предыдущего. Во время подготовки к работе без сети оказалось, что данное устройство не сможет работать без сети (см. Дозагрузка). Обычно, потому что браузер очень старый, и не поддерживает такие технологии. В этом случае такое старое устройство может иметь проблемы безопасного соединения. Иногда на подобные устройства имеет смысл отправлять второй варианты ссылки (см. Ссылки и соединение). Если браузер современный, то это может означать что пользователь пришёл в геолокацию в режиме Инкогнито, что очень-очень странно. Определять координаты это не помешает, но ситуация вызывает вопросы.|
|0-2|Диагностическое сообщение одного из трёх следующих видов.|
||"Запрос о доступе к местоположению возможен. Сейчас спросим" — означает, что мы проверили, в каком состоянии находится разрешение геолокации, и оно может «спрашивать». Это нормальное, удачное для нас состояние.|
||"Доступ к местоположению был разрешён на момент открытия страницы. Не первый раз?" — редкая история при первом заходе. Получается, что мы сейчас будем определять координаты без подтверждения пользователя. При этом часто встречается, когда пользователь уже заходил ранее и положительно ответил на наш запрос.|
||"Доступ к местоположению был запрещён ещё до захода по ссылке. Ждать бесполезно. Нужно или давать инструкцию о том, как разрешить доступ, либо пробовать какие-то другие способы или приложения" — если это первый заход, то любой сервис геолокации закончит тем же: невозможностью получить точные координаты. Но может просто пользователь в предыдущий раз уже нажал не туда, это редко, но бывает.|

</div>

> Если устройство заходит, но не отчитывается, значит с ним что-то не так. Возможно, оно очень старое, тогда это будет видно по номеру версии. А может быть это только что был не потерявшийся, а пришёл какой-нибудь бот, который ищет уязвимости в сайтах. Бот только загружает страницу, но не выполняет её код.

## Определение координат

<div class="table-wrapper" markdown="block">

|Способ|Смысл
|-|:-|
|0-3|Ненастоящий способ узнать местоположение пользователя. Попытка определить координаты по IP адресу. Сносно срабатывает в населённых пунктах и даже в помещениях. Вообще не зависит от разрешения определять координаты. В случае, когда устройство подключено к Wi-Fi сети, данные могут быть довольно точными. В природной среде обычно бесполезен.|
|1-1-?|Быстрая попытка получить данные любой, даже самой низкой точности и давности.|
|1-2-1|Попытка получить данные любой, даже самой низкой точности и давности, немного подождав.|
|1-2-2|Попытка получить более-менее свежие данные, даже самой низкой точности, немного подождав.|
|2-1-?|Попытка получить данные высокой точности любой давности.|
|2-2-?|Попытка получить свежие данные высокой точности.|
|3-?|Попытки получить самые свежие данные высокой точности, обновление каждые несколько секунд. Если данные приходят этим способом, то они и актуальные, и точные настолько, насколько это возможно на данном устройстве. Как правило, с ростом порядкового номера запроса, точность растёт, чем дольше непрерывно ждём, тем точность будет выше. Например, за один сеанс определения координат 3-20 будет лучше чем 3-1. Обращайте внимание на время получения данных, рост точности всегда прямо зависит от затраченного времени (время на уточнение обычно составляет не более трех минут). В этом режиме устройство всё время будет запрашивать координаты, и, если с ним идти, и оставить устройство включённым, то будет «хвост» из звёздочек геолокации по маршруту движения. Помните, что определение координат - энергозатратный процесс, а их отправка удваивает эту величину. Поэтому отправляются только те местоположения, которые отличаются примерно на десять метров, или у них значительно отличается точность. В движении расход батарейки на определение координат и отправку, соответственно, возрастает.|

</div>

## Диагностические сообщения с ошибками

<div class="table-wrapper" markdown="block">
  
|Ошибка|Комментарий|
|-|:-|
|TIMEOUT|Это скорее не ошибка, а нормальное состояние, когда местоположение нельзя определить мгновенно. Если координаты не приходят, а в диагностическом сообщении 0-2 нет явного запрета, это чаще всего значит, что пользователь не смог выполнить инструкцию дождаться высокой точности координат. Иногда процесс определения координат может занимать до пары минут, такое особенно часто может происходить с устройствами пожилых людей, на которых мало программ, интересующихся их местоположением с высокой точностью.|
|PERMISSION_DENIED|Надо смотреть какой вариант:|
||Похоже, что пользователь сам только что нажал 'Запретить' (Ошибка: PERMISSION_DENIED). Предложили другую ссылку geo.extremum.org — между запросом координат и ответом прошло время, похожее на то, что запрос координат появился, но пользователь нажал не туда, куда мы ожидали.|
||Доступ к местоположению был запрещён (Ошибка: PERMISSION_DENIED) — если до этого уже была ошибка, то увы.|
|POSITION_UNAVAILABLE|Может быть в случае, когда на устройстве нет модуля GPS/GLONASS, так бывает. Стоит проверить, что за устройство, если это очень дешёвое устройство, такое может быть порядке вещей, но, скорее всего, это показывает не просто на то, что браузеру запрещено определение местоположения, а оно запрещено либо всем приложениям вообще, либо браузеру, но каким-то очень сложным способом.|

</div>

## Разборы случаев
#### Типичный случай

<div class="table-wrapper" markdown="block">

|Время|||Комментарий|
|-|-|-|-|
|10:00:13|3-17|7 м|Похоже на точные качественные данные|
|10:00:10|Дозагрузка||В следующий раз страница геолокации сможет открыться без обращения в Интернет. Это быстрее и надёжнее.|
|10:00:06|3-5|113 м|Методам 3-? уже можно доверять. Это свежие данные, которые будут уточняться по мере «прогрева» геолокации.|
|10:00:05|1-2-1|2.4 км|Вытащили какие-то очень примерные координаты неизвестной давности. Если что-то пойдёт не так, можно будет ориентироваться хотя бы на них.|
|10:00:05|1-1-1|Таймаут, надо подождать (Ошибка: TIMEOUT) |Попытка получить координаты низкой точности и любой давности с очень коротким таймаутом, службы геолокации явно не могут ответить мгновенно, модуль GPS/GLONASS использовался не только что.|
|10:00:04|0-3|10 км|Резервный способ определения местоположения для помещений. Ориентироваться на него можно только в случае, когда это единственное, что сработало, и он выдал сносную точность вроде нескольких сотен метров, а в данном случае это не так.|
|10:00:03|0-2|Доступ к геолокации возможен. Сейчас спросим.|Типичная настройка пользовательского устройства, всё в порядке.|
|10:00:01|Ответ||Вместе с первым заходом означает, что это нормальный пользователь с нормальным устройством, пришёл первый раз, все шестерёнки сервиса закрутились успешно.|
|10:00:00|Заход|Первый раз здесь. Город по IP адресу: Санкт-Петербург.|Всё нормально.|

</div>

#### Когда пострадавший запрещает доступ по ошибке

<div class="table-wrapper" markdown="block">

|Время|||Комментарий|
|-|-|-|-|
|10:00:10|Дозагрузка||В следующий раз страница геолокации сможет открыться без обращения в Интернет. Это быстрее и надёжнее.|
|10:00:05|1-1-1|Похоже, пользователь сам только что нажал запретить, предложили другую ссылку geo.extremum.org (Ошибка: PERMISSION_DENIED)| На вопрос, разрешить ли доступ к геолокации, пользователь ответил отрицательно. Скорее всего по невнимательности (надо проинструктировать читать что написано) или от паники.|
|10:00:04|0-3|10 км|Резервный способ определения местоположения для помещений. Ориентироваться на него можно только в случае, когда это единственное, что сработало, и он выдал сносную точность вроде нескольких сотен метров, а в данном случае это не так.|
|10:00:03|0-2|Доступ к геолокации возможен. Сейчас спросим.|Типичная настройка пользовательского устройства, всё в порядке.|
|10:00:01|Ответ||Вместе с первым заходом означает, что это нормальный пользователь с нормальным устройством, пришёл первый раз, все шестерёнки сервиса закрутились успешно.|
|10:00:00|Заход|Первый раз здесь. Город по IP адресу: Санкт-Петербург.|Всё нормально.|

</div>

#### Когда пострадавший врёт
Иногда «пострадавший» делает вид, что находится в лесу, а сам в городской черте у кого-то. С недавних пор стало возможно догадаться об этом. Вроде как согасился нажать на ссылку, но запретил доступ, и сразу всё закрыл (нет этапа Дозагрузка).

<div class="table-wrapper" markdown="block">

|Время|||Комментарий|
|-|-|-|-|
|10:00:05|1-1-1|Похоже, пользователь сам только что нажал запретить, предложили другую ссылку geo.extremum.org (Ошибка: PERMISSION_DENIED)|Скорее всего, пользователь запретил намеренно. По данным метода 0-3 скорее всего пользователь находится в помещении и подключен к Wi-Fi, на это указывает относительно высокая точность.|
|10:00:04|0-3|550 м|Резервный способ определения местоположения для помещений. Ориентироваться на него можно только в случае, когда это единственное, что сработало, и он выдал сносную точность вроде нескольких сотен метров, и, в данном случае, это как раз так.|
|10:00:03|0-2|Доступ к геолокации возможен. Сейчас спросим.|Типичная настройка пользовательского устройства, всё в порядке.|
|10:00:01|Ответ||Вместе с первым заходом означает, что это нормальный пользователь с нормальным устройством, пришёл первый раз, все шестерёнки сервиса закрутились успешно.|
|10:00:00|Заход|Первый раз здесь. Город по IP адресу: Санкт-Петербург.|Всё нормально.|

</div>

#### Ходят не по ссылке
Пользователь явно заходит на страницу мониторинга через страницу определения координат. Возможно браузер настроен на «предзагрузку страниц». Так страницы открываются быстрее, но только потому, что браузер бежит впереди пользователя и загружает то, что, как он полагает, окажется пользователю полезным. В таких случаях лучше всего добавлять сервис в закладки и переходить из них.

<div class="table-wrapper" markdown="block">

|Время|||Комментарий|
|-|-|-|-|
|10:00:04|0-3|10 км|Резервный способ определения местоположения для помещений. Ориентироваться на него можно, только в случае, когда это единственное, что сработало, и он выдал сносную точность вроде нескольких сотен метров, а в данном случае это не так.|
|10:00:03|0-2|Доступ к геолокации запрещён до захода на страницу. Ждать бесполезно.|В сочетании с не первым заходом похоже, что наш пользователь здесь был уже много раз и запретил доступ к геолокации ещё в прошлый визит.|
|10:00:01|Ответ||Все шестерёнки сервиса закрутились успешно.|
|09:00:00|Заход|Не первый раз здесь. Город по IP адресу: Витебск.|Либо потерявшийся «рецидивист», либо кто-то случайно заходит на сервис через страницу определения координат.|

</div>

## Частые вопросы

**Вопрос**: Координаты определяются очень медленно и неточно, вы что-то испортили?

**Ответ**: Координаты могут определяться медленно и неточно. Кроме выдачи необходимых разрешений для определения координат нужно время. Устройство, на котором редко используется gps/glonass, сначала должно определить, где оно находится плюс-минус 500 км. Этот процесс значительно ускоряется технологией A-GPS при наличии мобильной сети, но, к сожалению, с 2022 года некоторые производители, такие как Qualcomm, отключили эти поправки для территорий РФ и РБ, и одна только эта часть может занимать до нескольких минут (обычно менее трёх) и увеличивается ещё больше при плохой видимости спутников. Например, сигналы спутников не проходят через стволы деревьев и тело человека. Если в плотном лесу как следует нависнуть на телефоном, то это совсем не уменьшит время определения местоположения. Мы привыкли к скорости определения координат, но всё это справедливо для устройств, где мы и фоновые процессы часто пользуются gps/glonass модулем, а потерявшиеся часто используют смартфон преимущественно для звонков. 

<hr>

**Вопрос**: Почему у меня долго определялись координаты, а потом я открыл другое приложение/сайт, и там они определились мгновенно?

**Ответ**: Точность - это функция от времени, любая вторая (третья) программа придёт уже на "прогретый" модуль. Метаться не нужно, нужно подождать.

<hr>

**Вопрос**: Очень много букв, можно попроще?

**Ответ**: Зайдите на [https://gis.extremum.org](https://gis.extremum.org) и включите доступные слои геолокации. Ищите оранжевую звёздочку координат в примерном районе местонахождения потерявшегося.

<hr>

**Вопрос**: Мы это всё внимательно прочитали и запилили ещё один прекрасный сервис определения координат, который почти так же хорош. Как нам его подключить к системе?

**Ответ**: Никак. Работа по подключению и поддержке таких сервисов непроста, они часто недостаточно стабильны и требуют много внимания, а пользуются ими три человека в год. Часто время их жизни невелико, обычно пара лет, пока не закончится энтузиазм авторов. Это нерационально, даже время затраченное на обсуждение интеграции не окупается временем использования.
